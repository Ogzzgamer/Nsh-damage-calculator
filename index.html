<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>傷害計算器 - 未包含內功效益計算初版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link href="https://fonts.googleapis.com/css2?family=Inter&family=Noto+Sans+TC&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            background: 
				radial-gradient(ellipse at top left, rgba(139, 92, 246, 0.3) 0%, transparent 50%),
				radial-gradient(ellipse at top right, rgba(59, 130, 246, 0.2) 0%, transparent 50%),
				radial-gradient(ellipse at bottom left, rgba(168, 85, 247, 0.2) 0%, transparent 50%),
				radial-gradient(ellipse at bottom right, rgba(99, 102, 241, 0.3) 0%, transparent 50%),
				radial-gradient(ellipse at center, #1e3a8a 0%, #0f172a 70%, #000000 100%);
			position: relative;
			overflow-x: hidden;
			min-height: 100vh;
			font-family: 'Noto Sans TC', sans-serif;
        }
		*:lang(en) {
			font-family: 'Inter', sans-serif;
		}
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .card-shadow:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .stat-input {
            transition: all 0.3s ease;
            color: #1e293b;
        }
        .stat-input:focus {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.25);
        }
        .set-effect-card {
            transition: all 0.3s ease;
            border-left: 4px solid;
        }
        .set-effect-card:hover {
            transform: scale(1.02);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .glow {
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);
        }
        .result-card {
            background: linear-gradient(135deg, #6d28d9, #8b5cf6);
            color: white;
        }
        .section-title {
            background: linear-gradient(90deg, #f0f0f0, #d2e5ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.2);
        }
        .gradient-divider {
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            border-radius: 3px;
        }
        .level-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 5px;
        }
        .level-85 { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .level-83 { background: linear-gradient(135deg, #94a3b8, #64748b); color: white; }
        .level-81 { background: linear-gradient(135deg, #a16207, #854d0e); color: white; }
        .five-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }
        .five-stat-card {
            background: #a78bfa;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 1px solid #8b5cf6;
			box-shadow: 0 4px 15px rgba(139, 92, 246, 0.35);
        }
        .five-stat-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #f0f0f0;
        }
        .five-stat-label {
            font-size: 0.85rem;
            color: #eeeeee;
        }
        .stat-diff {
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0 4px;
            border-radius: 4px;
        }
        .stat-increase {
            background-color: rgba(16, 185, 129, 0.1);
            color: #34d399;
        }
        .stat-decrease {
            background-color: rgba(239, 68, 68, 0.1);
            color: #f87171;
        }
        .conversion-card {
            background: rgba(56, 189, 248, 0.15);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(56, 189, 248, 0.3);
        }
        .conversion-header {
            background: linear-gradient(90deg, #f0f0f0, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .damage-result-card {
            border-left: 4px solid;
            padding: 12px;
            border-radius: 8px;
        }
        .damage-increase {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }
        .damage-decrease {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }
        .set-effect-header {
            position: relative;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }
        .set-effect-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #8b5cf6, transparent);
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(200%);
            transition: transform 0.4s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #8b5cf6;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .unique-badge {
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 5px;
        }
        .set-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 5px;
        }
        
        /* 添加配色 */
        .card-gradient-1 { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
        .card-gradient-2 { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .card-gradient-3 { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
        .card-gradient-4 { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .card-gradient-5 { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); }
        .card-gradient-6 { background: linear-gradient(135deg, #581c87 0%, #4c1d95 100%); }
        .card-gradient-7 { background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%); }
        .card-gradient-8 { background: linear-gradient(135deg, #374151 0%, #1f2937 100%); }
        .card-gradient-9 { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        
        /* 星空背景樣式 */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .meteor {
            position: fixed;
            width: 2px;
            height: 2px;
            background: linear-gradient(45deg, #fff, transparent);
            border-radius: 50%;
            box-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #fff;
            animation: meteor 3s linear infinite;
            z-index: 1;
        }

        @keyframes meteor {
            0% {
                transform: translateX(-100px) translateY(-100px);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(100vw) translateY(100vh);
                opacity: 0;
            }
        }

        .stardust {
            position: fixed;
            width: 1px;
            height: 1px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: float 8s linear infinite;
            z-index: 1;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(50px);
                opacity: 0;
            }
        }
        

        
        /* 星空風格按鈕 */
        .star-btn {
            background: linear-gradient(135deg, var(--from-color), var(--to-color));
            border: none;
            color: white;
            border-radius: 12px;
            font-weight: 600;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), 
                        0 0 15px rgba(139, 92, 246, 0.4);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(0);
        }
        
        .star-btn i {
            margin-right: 8px;
            font-size: 1.1em;
        }
        
        .star-btn:hover {
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 
                        0 0 20px rgba(139, 92, 246, 0.6);
        }
        
        .star-btn:active {
            transform: translateY(2px) scale(0.98);
        }
        
        .star-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .star-btn:hover::before {
            left: 100%;
        }
        
        .damage-btn {
            --from-color: #f87171;
            --to-color: #ef4444;
        }
        
        .base-btn {
            --from-color: #6366f1;
            --to-color: #4f46e5;
        }
        
        .new-equip-btn {
            --from-color: #ec4899;
            --to-color: #d946ef;
        }
        
        .calc-btn {
            --from-color: #8b5cf6;
            --to-color: #7c3aed;
        }
		
		
    </style>
</head>
<body class="min-h-screen p-4" style="background: radial-gradient(ellipse at bottom, #1e3a8a 0%, #0f172a 100%);">
	<div class="stars" id="stars"></div>
    <div class="max-w-7xl mx-auto">
        <!-- 標題 -->
        <div class="text-center mb-8 mt-4">
            <h1 class="text-4xl font-bold text-white mb-2">傷害計算器</h1>
            <p class="text-purple-300 mb-4">未包含內功效益初版</p>
            <div class="w-32 h-1 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full mx-auto"></div>
        </div>

        <!-- 數據加載狀態 -->
        <div id="dataLoading" class="text-center p-8">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-purple-300 font-medium">正在加載裝備與目標數據...</p>
            <p class="text-sm text-purple-200 mt-2">請稍候，數據將從外部JSON文件加載</p>
        </div>

        <!-- 職業選擇區域 (初始隱藏) -->
        <div id="appContent" class="hidden">
            <!-- 職業選擇區域 -->
            <div class="mb-8">
                <div class="card-shadow rounded-2xl p-6 card-gradient-1 card-hover">
                    <h2 class="text-xl font-semibold mb-6 section-title">⚔️ 職業選擇</h2>
                    <div class="grid lg:grid-cols-3 gap-6">
                        <!-- 主職業選擇 -->
                        <div>
                            <h3 class="text-lg font-medium mb-3 text-gray-100"><i class="fas fa-crown mr-2 text-amber-300"></i>主職業</h3>
                            <select id="mainProfessionSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white bg-opacity-90 text-gray-800">
                                <option value="">請選擇主職業</option>
                                <optgroup label="內功職業">
                                    <option value="神相" selected>神相</option>
                                    <option value="九靈">九靈</option>
                                    <option value="素問">素問</option>
                                    <option value="龍吟">龍吟</option>
                                </optgroup>
                                <optgroup label="外功職業">
                                    <option value="碎夢">碎夢</option>
                                    <option value="鐵衣">鐵衣</option>
                                    <option value="血河">血河</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- 特質選擇 -->
                        <div>
                            <h3 class="text-lg font-medium mb-3 text-gray-100"><i class="fas fa-star mr-2 text-purple-300"></i>特質 (副職業)</h3>
                            <select id="traitSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white bg-opacity-90 text-gray-800">
                                <option value="">請選擇特質</option>
                                <optgroup label="內功特質">
                                    <option value="神相">神相</option>
                                    <option value="九靈">九靈</option>
                                    <option value="素問">素問</option>
                                    <option value="龍吟" selected>龍吟</option>
                                </optgroup>
                                <optgroup label="外功特質">
                                    <option value="碎夢">碎夢</option>
                                    <option value="鐵衣">鐵衣</option>
                                    <option value="血河">血河</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- 職業效果顯示 -->
                        <div>
                            <h3 class="text-lg font-medium mb-3 text-gray-100"><i class="fas fa-magic mr-2 text-blue-300"></i>職業效果</h3>
                            <div id="professionEffects" class="text-sm bg-white bg-opacity-20 p-3 rounded-lg h-32 text-white">
                                <div class="flex items-center justify-center h-full">
                                    <i class="fas fa-info-circle mr-2"></i>請選擇職業查看效果
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 目標選擇區域 -->
            <div class="mb-8">
                <div class="card-shadow rounded-2xl p-6 card-gradient-2 card-hover">
                    <div class="grid lg:grid-cols-2 gap-6">
                        <!-- 目標選擇 -->
                        <div>
                            <h2 class="text-xl font-semibold mb-4 section-title">🎯 選擇目標</h2>
                            <select id="targetSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white bg-opacity-90 text-gray-800">
                                <option value="">請選擇目標</option>
                                <!-- 目標選項將從JSON加載 -->
                            </select>
                        </div>

                        <!-- 目標屬性顯示 -->
                        <div>
                            <h3 class="text-xl font-semibold mb-4 section-title">📊 目標屬性</h3>
                            <div id="targetStats" class="space-y-2 text-sm p-3 bg-white bg-opacity-20 rounded-lg text-white">
                                <div class="flex items-center justify-center h-24">
                                    <i class="fas fa-crosshairs mr-2"></i>請先選擇目標
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 五維屬性顯示區域 -->
            <div class="mb-8">
                <div class="card-shadow rounded-2xl p-6 card-gradient-3 card-hover">
                    <h2 class="text-xl font-semibold mb-6 section-title">📊 五維屬性</h2>
                    <div class="five-stats-grid">
                        <div class="five-stat-card">
                            <div class="five-stat-value" id="strengthValue">200</div>
                            <div class="five-stat-label">力量</div>
                        </div>
                        <div class="five-stat-card">
                            <div class="five-stat-value" id="qihaiValue">180</div>
                            <div class="five-stat-label">氣海</div>
                        </div>
                        <div class="five-stat-card">
                            <div class="five-stat-value" id="agilityValue">150</div>
                            <div class="five-stat-label">身法</div>
                        </div>
                        <div class="five-stat-card">
                            <div class="five-stat-value" id="constitutionValue">120</div>
                            <div class="five-stat-label">根骨</div>
                        </div>
                        <div class="five-stat-card">
                            <div class="five-stat-value" id="enduranceValue">100</div>
                            <div class="five-stat-label">耐力</div>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-purple-200">
                        <p><i class="fas fa-info-circle text-blue-300 mr-2"></i>五維屬性會根據職業自動轉換為戰鬥屬性</p>
                    </div>
                </div>
            </div>

            <!-- 五維屬性轉換顯示 -->
            <div class="mb-8">
                <div class="card-shadow rounded-2xl p-6 card-gradient-4 card-hover">
                    <h2 class="text-xl font-semibold mb-6 section-title">🔄 五維屬性轉換</h2>
                    <div class="grid md:grid-cols-2 gap-6" id="conversionDisplay">
                        <div class="text-center py-4 text-white">
                            請選擇職業查看轉換規則
                        </div>
                    </div>
                </div>
            </div>

            <!-- 傷害計算區域 -->
            <div class="mt-8">
                <div class="card-shadow rounded-2xl p-6 card-gradient-5 card-hover">
                    <h2 class="text-xl font-semibold mb-4 section-title">⚔️ 傷害計算器</h2>
                    <div class="grid lg:grid-cols-3 gap-6">
                        <!-- 當前總屬性輸入 -->
                        <div>
                            <h3 class="text-lg font-medium mb-3 text-purple-200"><i class="fas fa-calculator mr-2 text-blue-300"></i>當前總屬性 (含裝備)</h3>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">攻擊</label>
                                        <input type="number" id="current_attack" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="3500">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">元素攻擊</label>
                                        <input type="number" id="current_elemental_attack" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="1800">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">破防</label>
                                        <input type="number" id="current_armor_break" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="1200">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">忽視抗性</label>
                                        <input type="number" id="current_ignore_resist" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="300">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">命中</label>
                                        <input type="number" id="current_hit" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="800">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">會心</label>
                                        <input type="number" id="current_crit" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="1500">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">首領克制</label>
                                        <input type="number" id="current_boss_damage" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="450">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">首領克制%</label>
                                        <input type="number" id="current_boss_damage_percent" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="12.5" step="0.1">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">會心傷害%</label>
                                        <input type="number" id="current_crit_damage" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="165.0" step="0.1">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">破盾</label>
                                        <input type="number" id="current_shield_break" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="200">
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <h4 class="text-md font-medium mb-2 text-purple-200"><i class="fas fa-dumbbell mr-2 text-cyan-300"></i>五維屬性</h4>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-sm mb-1 text-purple-200">力量</label>
                                            <input type="number" id="current_strength" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="200">
                                        </div>
                                        <div>
                                            <label class="block text-sm mb-1 text-purple-200">氣海</label>
                                            <input type="number" id="current_qihai" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="180">
                                        </div>
                                        <div>
                                            <label class="block text-sm mb-1 text-purple-200">身法</label>
                                            <input type="number" id="current_agility" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="150">
                                        </div>
                                        <div>
                                            <label class="block text-sm mb-1 text-purple-200">根骨</label>
                                            <input type="number" id="current_constitution" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="120">
                                        </div>
                                        <div>
                                            <label class="block text-sm mb-1 text-purple-200">耐力</label>
                                            <input type="number" id="current_endurance" class="w-full p-2 border border-gray-300 rounded-lg text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="100">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 手動微調區域 -->
                        <div>
                            <h3 class="text-lg font-medium mb-3 text-purple-200"><i class="fas fa-sliders-h mr-2 text-purple-300"></i>手動微調 (可選)</h3>
                            <div class="p-4 bg-white bg-opacity-20 rounded-lg border border-gray-200">
                                <h4 class="text-sm font-medium mb-3 text-purple-200">新裝備額外調整</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">攻擊</label>
                                        <input type="number" id="manual_attack" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">元素攻擊</label>
                                        <input type="number" id="manual_elemental_attack" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">破防</label>
                                        <input type="number" id="manual_armor_break" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">忽視抗性</label>
                                        <input type="number" id="manual_ignore_resist" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">命中</label>
                                        <input type="number" id="manual_hit" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">會心</label>
                                        <input type="number" id="manual_crit" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">首領克制</label>
                                        <input type="number" id="manual_boss_damage" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">首領克制%</label>
                                        <input type="number" id="manual_boss_damage_percent" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0" step="0.1">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-1 text-purple-200">會心傷害%</label>
                                        <input type="number" id="manual_crit_damage" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0" step="0.1">
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <h4 class="text-sm font-medium mb-3 text-purple-200">五維屬性調整</h4>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-sm mb-1 text-purple-200">力量</label>
                                            <input type="number" id="manual_strength" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0">
                                        </div>
                                        <div>
                                            <label class="block text-sm mb-1 text-purple-200">氣海</label>
                                            <input type="number" id="manual_qihai" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0">
                                        </div>
                                        <div>
                                            <label class="block text-sm mb-1 text-purple-200">身法</label>
                                            <input type="number" id="manual_agility" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0">
                                        </div>
                                        <div>
                                            <label class="block text-sm mb-1 text-purple-200">根骨</label>
                                            <input type="number" id="manual_constitution" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0">
                                        </div>
                                        <div>
                                            <label class="block text-sm mb-1 text-purple-200">耐力</label>
                                            <input type="number" id="manual_endurance" class="w-full p-2 border border-gray-300 rounded text-sm stat-input bg-white bg-opacity-90 text-gray-800" value="0">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 傷害計算結果 -->
                        <div>
                            <h3 class="text-lg font-medium mb-3 text-purple-200"><i class="fas fa-bullseye mr-2 text-red-300"></i>傷害計算結果</h3>
                            <div class="space-y-4">
                                <button onclick="calculateDamage()" class="w-full star-btn calc-btn">
                                    <i class="fas fa-calculator"></i> 計算傷害差異
                                </button>
                                <div id="damageResults" class="space-y-3">
                                    <div class="text-center text-sm p-4 bg-white bg-opacity-20 rounded-lg text-white">
                                        <i class="fas fa-lightbulb text-purple-300 text-lg mb-2"></i>
                                        <p class="mb-1">1. 輸入當前總屬性</p>
                                        <p class="mb-1">2. 選擇當前裝備並計算基礎面板</p>
                                        <p class="mb-1">3. 選擇新裝備配置</p>
                                        <p>4. 點擊計算傷害差異</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 裝備配置區域 -->
            <div class="mt-8">
                <div class="card-shadow rounded-2xl p-6 card-gradient-6 card-hover">
                    <h2 class="text-xl font-semibold mb-6 section-title">🛡️ 裝備配置</h2>
                    
                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- 當前穿戴裝備 -->
                        <div>
                            <h3 class="text-lg font-medium mb-4 text-purple-200"><i class="fas fa-user mr-2"></i>當前穿戴裝備</h3>
                            <div class="p-4 bg-white bg-opacity-20 rounded-lg border border-blue-200">
                                <div class="space-y-3" id="currentEquipmentSelectors">
                                    <!-- 當前裝備選擇器將在這裡生成 -->
                                </div>
                                <button onclick="calculateBaseStats()" class="w-full mt-4 star-btn base-btn">
                                    <i class="fas fa-calculator"></i> 計算基礎面板
                                </button>
                            </div>
                            
                            <!-- 基礎面板顯示 -->
                            <div class="mt-4 p-4 bg-green-500 bg-opacity-20 rounded-lg border border-green-900">
                                <h4 class="text-sm font-medium mb-3 text-purple-200">基礎面板 (不含裝備)</h4>
                                <div id="baseStatsDisplay" class="text-sm text-white">
                                    <div>請先計算基礎面板</div>
                                </div>
                            </div>
                        </div>

                        <!-- 新裝備配置 -->
                        <div>
                            <h3 class="text-lg font-medium mb-4 text-purple-200"><i class="fas fa-sync-alt mr-2"></i>新裝備配置</h3>
                            <div class="p-4 bg-white bg-opacity-20 rounded-lg border border-purple-200">
                                <div class="space-y-3" id="newEquipmentSelectors">
                                    <!-- 新裝備選擇器將在這裡生成 -->
                                </div>
                                <button onclick="calculateNewEquipmentStats()" class="w-full mt-4 star-btn new-equip-btn">
                                    <i class="fas fa-calculator"></i> 計算新裝備屬性
                                </button>
                            </div>
                            
                            <!-- 新裝備屬性顯示 -->
                            <div class="mt-4 p-4 bg-orange-200 bg-opacity-50 rounded-lg border border-orange-400">
                                <h4 class="text-sm font-medium mb-3 text-purple-200">新裝備屬性對比 (與當前裝備差異)</h4>
                                <div id="newEquipmentStatsDisplay" class="text-sm text-white">
                                    <div>請先選擇新裝備並計算</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 套裝效果顯示區域 -->
            <div class="mt-4 mb-8">
                <div class="card-shadow rounded-2xl p-6 card-gradient-7 card-hover">
                    <h2 class="text-xl font-semibold mb-4 section-title">🧩 裝備效果</h2>
                    <div class="grid lg:grid-cols-2 gap-6">
                        <!-- 當前裝備套裝效果 -->
                        <div>
                            <h3 class="text-lg font-medium mb-3 set-effect-header text-purple-200"><i class="fas fa-tshirt mr-2"></i>當前裝備效果</h3>
                            <div id="currentSetEffects" class="p-3 bg-white bg-opacity-20 rounded-lg border border-blue-200 text-white">
                                <div class="text-sm">請先選擇裝備</div>
                            </div>
                        </div>
                        
                        <!-- 新裝備套裝效果 -->
                        <div>
                            <h3 class="text-lg font-medium mb-3 set-effect-header text-purple-200"><i class="fas fa-tshirt mr-2"></i>新裝備效果</h3>
                            <div id="newSetEffects" class="p-3 bg-white bg-opacity-20 rounded-lg border border-purple-200 text-white">
                                <div class="text-sm">請先選擇裝備</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 五維屬性轉換說明 -->
            <div class="mt-8 mb-8">
                <div class="card-shadow rounded-2xl p-6 card-gradient-8 card-hover">
                    <h2 class="text-xl font-semibold mb-4 section-title">📚 五維屬性轉換說明</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="p-4 bg-white bg-opacity-20 rounded-lg border border-amber-100">
                            <h3 class="text-lg font-medium mb-3 text-purple-200"><i class="fas fa-exchange-alt mr-2"></i>基礎轉換規則</h3>
                            <ul class="text-sm space-y-2 text-white">
                                <li><span class="font-medium">力量</span> → 攻擊: 4.65, 破防: 2.0</li>
                                <li><span class="font-medium">氣海</span> → 攻擊: 4.65, 破防: 2.0</li>
                                <li><span class="font-medium">身法</span> → 會心: 1.6, 命中: 0.83</li>
                                <li><span class="font-medium">根骨</span> → 無直接轉換</li>
                                <li><span class="font-medium">耐力</span> → 無直接轉換</li>
                            </ul>
                        </div>
                        <div class="p-4 bg-white bg-opacity-20 rounded-lg border border-orange-100">
                            <h3 class="text-lg font-medium mb-3 text-purple-200"><i class="fas fa-user-tie mr-2"></i>職業特殊轉換</h3>
                            <ul class="text-sm space-y-2 text-white">
                                <li><span class="font-medium">神相</span>: 氣海 → 命中: 0.83</li>
                                <li><span class="font-medium">九靈</span>: 耐力 → 攻擊: 1.65</li>
                                <li><span class="font-medium">龍吟</span>: 根骨 → 破防: 2.0</li>
                                <li><span class="font-medium">碎夢</span>: 身法 → 會心: 0.6</li>
                                <li><span class="font-medium">血河</span>: 根骨 → 攻擊: 1.65</li>
                                <li class="font-bold"><span class="font-medium">特殊規則</span>: 當主職業為外功且特質為神相時，力量→命中: 0.83</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 頁腳 -->
            <div class="text-center mt-12 mb-6 text-sm text-purple-300">
                <p>傷害計算器 v1.0 | 試作初版</p>
                <p class="mt-2">© 2025 逆水寒傷害計算工具</p>
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <i class="fas fa-info-circle mr-2"></i>當主職業為外功且特質為神相時，已啟用力量轉命中效果！
    </div>

    <script>
        // 全局變量存儲加載的數據
        let TARGET_PRESETS = {};
        let EQUIPMENT_PRESETS_BY_SLOT = {};
        
        // 套裝效果映射
        const SET_EFFECTS = {
            81: { 
                upperTwoSet: { bossDamage: 607 }, // 首領克制
                upperFourSet: { bossDamagePercent: 0.067 }, // 首領克制%
                lowerTwoSet: { bossDamagePercent: 0.084, critDamage: 0 }
            },
            83: { 
                upperTwoSet: { bossDamage: 619 }, 
                upperFourSet: { bossDamagePercent: 0.075 },
                lowerTwoSet: { bossDamagePercent: 0.085, critDamage: 0.04 }
            },
            85: { 
                upperTwoSet: { bossDamage: 630 }, 
                upperFourSet: { bossDamagePercent: 0.082 },
                lowerTwoSet: { bossDamagePercent: 0.087, critDamage: 0.041 }
            }
        };

        // 獨珍效果映射
        const UNIQUE_EFFECTS = {
            "薛北鯤·孤鷹腰帶": function(totalStats) {
				return {
					attack: totalStats.constitution * 1  // 攻击 = 根骨 * 1
				};
			},
			"牧野彌戒指": { bossDamage: 180, crit: 100 },
			"柳星聞項鍊": { bossDamagePercent: 0.06, critDamage: 0.05 },
			"南問雪手鐲": { elementalAttack: 150, armorBreak: 100 },
			"黑天尊使護腕": { attack: 200, armorBreak: 100 },
		};

        // 上半身部位 (適用百鍊套裝效果)
        const UPPER_BODY_SLOTS = ["頭部", "手套", "護腕", "腰帶", "鞋子"];
        
        // 下半身部位 (適用百鍊套裝效果)
        const LOWER_BODY_SLOTS = ["飾品1", "飾品2", "項鍊"];

        // 五維屬性轉換規則
        const FIVE_STATS_CONVERSION = {
            "力量": {"攻擊": 4.65, "破防": 2},
            "氣海": {"攻擊": 4.65, "破防": 2},
            "身法": {"會心": 1.6, "命中": 0.83},
            "根骨": {},
            "耐力": {}
        };

        // 職業分類
        const PROFESSION_TYPES = {
            "內功": ["神相", "九靈", "素問", "龍吟"],
            "外功": ["碎夢", "鐵衣", "血河"]
        };

        // 職業特殊轉換規則
        const PROFESSION_CONVERSION = {
            "神相": {"氣海": {"命中": 0.83}},
            "九靈": {"耐力": {"攻擊": 1.65}},
            "素問": {},
            "龍吟": {"根骨": {"破防": 2}},
            "碎夢": {"身法": {"會心": 0.6}},
            "鐵衣": {},
            "血河": {"根骨": {"攻擊": 1.65}}
        };

        // 職業效果描述
        const PROFESSION_EFFECTS = {
            "神相": "每點氣海額外+0.83命中",
            "九靈": "每點耐力額外+1.65攻擊",
            "素問": "暫無特殊轉換",
            "龍吟": "每點根骨額外+2破防",
            "碎夢": "每點身法額外+0.6會心",
            "鐵衣": "暫無特殊轉換",
            "血河": "每點根骨額外+1.65攻擊"
        };

        // 當前選擇的職業
        let selectedMainProfession = "神相";
        let selectedTrait = "龍吟";
        let specialRuleActive = false;

        // 屬性名稱對應
        const STAT_NAMES = [
            "攻擊", "元素攻擊", "破防", "忽視抗性", "命中", "會心", "首領克制", 
            "首領克制%", "會心傷害", "破盾", "力量", "氣海", "身法", "根骨", "耐力"
        ];

        // 裝備部位
        const EQUIPMENT_SLOTS = [
            "頭部", "手套", "護腕", "腰帶", "護甲", "鞋子", 
            "武器", "飾品1", "飾品2", "戒指1", "戒指2", "項鍊"
        ];

        // 當前穿戴的裝備 (用於計算基礎面板)
        let currentWearingEquipment = {};
        
        // 新裝備配置
        let newEquipment = {};
        
        // 基礎面板屬性 (不含裝備)
        let baseStats = new Array(15).fill(0);

        // 加載外部JSON數據
        function loadExternalData() {
            // 使用Promise.all同時加載兩個JSON文件
            Promise.all([
                fetch('targets.json').then(response => response.json()),
                fetch('equipments.json').then(response => response.json())
            ])
            .then(([targets, equipments]) => {
                TARGET_PRESETS = targets;
                EQUIPMENT_PRESETS_BY_SLOT = equipments;
                
                // 隱藏加載指示器
                document.getElementById('dataLoading').classList.add('hidden');
                // 顯示應用內容
                document.getElementById('appContent').classList.remove('hidden');
                
                // 初始化應用
                initializeApp();
            })
            .catch(error => {
                console.error('加載數據時出錯:', error);
                document.getElementById('dataLoading').innerHTML = `
                    <div class="text-center p-8">
                        <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                        <p class="text-red-700 font-bold mb-2">數據加載失敗</p>
                        <p class="text-gray-600 mb-4">請檢查JSON文件是否可用</p>
                        <button onclick="location.reload()" class="px-4 py-2 bg-purple-600 text-white rounded-lg">
                            <i class="fas fa-sync-alt mr-2"></i>重新加載
                        </button>
                    </div>
                `;
            });
        }
        

        // 初始化應用
        function initializeApp() {
            createCurrentEquipmentSelectors();
            createNewEquipmentSelectors();
            setupEventListeners();
            updateSetEffects('current');
            updateSetEffects('new');
            updateFiveStatsDisplay();
            updateProfessionEffects();
            updateConversionDisplay();
            populateTargetSelect();
            setupFiveStatsInputListeners();
        }

        // 填充目標選擇下拉菜單
        function populateTargetSelect() {
            const targetSelect = document.getElementById('targetSelect');
            targetSelect.innerHTML = '<option value="">請選擇目標</option>';
            
            for (const targetName in TARGET_PRESETS) {
                const option = document.createElement('option');
                option.value = targetName;
                option.textContent = targetName;
                targetSelect.appendChild(option);
            }
            
            // 設置默認值
            if (TARGET_PRESETS.hasOwnProperty('英雄鏡天閣禁閣')) {
                targetSelect.value = '英雄鏡天閣禁閣';
            }
            
            updateTargetStats();
        }

        // 設置五維屬性輸入監聽
        function setupFiveStatsInputListeners() {
            const stats = ['strength', 'qihai', 'agility', 'constitution', 'endurance'];
            stats.forEach(stat => {
                document.getElementById(`current_${stat}`).addEventListener('input', function() {
                    updateFiveStatsDisplay();
                });
            });
        }

        // 更新五維屬性顯示
        function updateFiveStatsDisplay() {
            document.getElementById('strengthValue').textContent = 
                document.getElementById('current_strength').value || '0';
            document.getElementById('qihaiValue').textContent = 
                document.getElementById('current_qihai').value || '0';
            document.getElementById('agilityValue').textContent = 
                document.getElementById('current_agility').value || '0';
            document.getElementById('constitutionValue').textContent = 
                document.getElementById('current_constitution').value || '0';
            document.getElementById('enduranceValue').textContent = 
                document.getElementById('current_endurance').value || '0';
        }

        // 更新轉換顯示
        function updateConversionDisplay() {
            const container = document.getElementById('conversionDisplay');
            
            if (!selectedMainProfession) {
                container.innerHTML = '<div class="text-center py-4 text-white"><div>請選擇職業查看轉換規則</div></div>';
                return;
            }
            
            const professionType = PROFESSION_TYPES["內功"].includes(selectedMainProfession) ? "內功" : "外功";
            
            let html = '';
            
            // 主職業轉換
            html += `
                <div class="conversion-card">
                    <h3 class="text-md font-medium conversion-header mb-3">主職業: ${selectedMainProfession} (${professionType})</h3>
                    <ul class="text-sm text-white space-y-2">
            `;
            
            if (professionType === "外功") {
                html += `
                    <li><span class="font-medium">力量</span> → 攻擊: 4.65, 破防: 2.0</li>
                    <li><span class="font-medium">身法</span> → 會心: 1.6, 命中: 0.83</li>
                `;
            } else {
                html += `
                    <li><span class="font-medium">氣海</span> → 攻擊: 4.65, 破防: 2.0</li>
                    <li><span class="font-medium">身法</span> → 會心: 1.6, 命中: 0.83</li>
                `;
            }
            
            // 添加職業特殊轉換
            if (PROFESSION_CONVERSION[selectedMainProfession]) {
                Object.keys(PROFESSION_CONVERSION[selectedMainProfession]).forEach(stat => {
                    const conversions = PROFESSION_CONVERSION[selectedMainProfession][stat];
                    Object.keys(conversions).forEach(target => {
                        html += `<li><span class="font-medium">${stat}</span> → ${target}: ${conversions[target]}</li>`;
                    });
                });
            }
            
            html += `</ul></div>`;
            
            // 特質轉換
            if (selectedTrait) {
                html += `
                    <div class="conversion-card">
                        <h3 class="text-md font-medium conversion-header mb-3">特質: ${selectedTrait}</h3>
                        <ul class="text-sm text-white space-y-2">
                `;
                
                // 特殊規則：主職業為外功且特質為神相時
                if (selectedMainProfession && PROFESSION_TYPES["外功"].includes(selectedMainProfession) && 
                    selectedTrait === "神相") {
                    html += `<li><span class="font-medium">力量</span> → 命中: 0.83</li>`;
                } 
                // 其他特質轉換
                else if (PROFESSION_CONVERSION[selectedTrait]) {
                    Object.keys(PROFESSION_CONVERSION[selectedTrait]).forEach(stat => {
                        const conversions = PROFESSION_CONVERSION[selectedTrait][stat];
                        Object.keys(conversions).forEach(target => {
                            html += `<li><span class="font-medium">${stat}</span> → ${target}: ${conversions[target]}</li>`;
                        });
                    });
                } else {
                    html += `<li>暫無特殊轉換</li>`;
                }
                
                html += `</ul></div>`;
            }
            
            container.innerHTML = html;
        }

        // 創建當前裝備選擇器
        function createCurrentEquipmentSelectors() {
            const container = document.getElementById('currentEquipmentSelectors');
            container.innerHTML = '';

            EQUIPMENT_SLOTS.forEach(slot => {
                // 確保該裝備槽位存在於數據中
                if (!EQUIPMENT_PRESETS_BY_SLOT[slot]) {
                    console.warn(`未找到槽位 ${slot} 的裝備數據`);
                    return;
                }
                
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <label class="text-sm w-16 font-medium text-purple-200">${slot}</label>
                        <select id="current_equipment_${slot}" class="flex-1 p-2 border border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white bg-opacity-90 text-gray-800
">
                            ${Object.keys(EQUIPMENT_PRESETS_BY_SLOT[slot]).map(item => 
                                `<option value="${item}">${item}</option>`
                            ).join('')}
                        </select>
                    </div>
                `;
                container.appendChild(div);

                // 設置事件監聽器
                const select = div.querySelector('select');
                select.addEventListener('change', () => {
                    currentWearingEquipment[slot] = select.value;
                    updateSetEffects('current');
                });

                // 初始化選擇
                const defaultItem = slot === "武器" ? "83百鍊武器" : 
                                  slot === "護甲" ? "81柳星聞‧黯月孤照袍" : 
                                  Object.keys(EQUIPMENT_PRESETS_BY_SLOT[slot])[1];
                select.value = defaultItem;
                currentWearingEquipment[slot] = defaultItem;
            });
        }

        // 創建新裝備選擇器
        function createNewEquipmentSelectors() {
            const container = document.getElementById('newEquipmentSelectors');
            container.innerHTML = '';

            EQUIPMENT_SLOTS.forEach(slot => {
                // 確保該裝備槽位存在於數據中
                if (!EQUIPMENT_PRESETS_BY_SLOT[slot]) {
                    console.warn(`未找到槽位 ${slot} 的裝備數據`);
                    return;
                }
                
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <label class="text-sm w-16 font-medium text-purple-200">${slot}</label>
                        <select id="new_equipment_${slot}" class="flex-1 p-2 border border-purple-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white bg-opacity-90 text-gray-800">
                            ${Object.keys(EQUIPMENT_PRESETS_BY_SLOT[slot]).map(item => 
                                `<option value="${item}">${item}</option>`
                            ).join('')}
                        </select>
                    </div>
                `;
                container.appendChild(div);

                // 設置事件監聽器
                const select = div.querySelector('select');
                select.addEventListener('change', () => {
                    newEquipment[slot] = select.value;
                    updateSetEffects('new');
                });

                // 初始化選擇
                const defaultItem = slot === "武器" ? "85百鍊武器" : 
                                  slot === "護甲" ? "李白天地光陰袍" : 
                                  Object.keys(EQUIPMENT_PRESETS_BY_SLOT[slot])[1];
                select.value = defaultItem;
                newEquipment[slot] = defaultItem;
            });
        }

        // 設置事件監聽器
        function setupEventListeners() {
            document.getElementById('targetSelect').addEventListener('change', function() {
                updateTargetStats();
            });
            
            document.getElementById('mainProfessionSelect').addEventListener('change', function() {
                selectedMainProfession = this.value;
                updateProfessionEffects();
                updateConversionDisplay();
                checkSpecialRule();
            });
            
            document.getElementById('traitSelect').addEventListener('change', function() {
                selectedTrait = this.value;
                updateProfessionEffects();
                updateConversionDisplay();
                checkSpecialRule();
            });
        }
        
        // 檢查特殊規則
        function checkSpecialRule() {
            const notification = document.getElementById('notification');
            specialRuleActive = false;
            
            if (selectedMainProfession && PROFESSION_TYPES["外功"].includes(selectedMainProfession) && 
                selectedTrait === "神相") {
                specialRuleActive = true;
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // 更新目標屬性顯示
        function updateTargetStats() {
            const targetSelect = document.getElementById('targetSelect');
            const targetStatsDiv = document.getElementById('targetStats');
            const selectedTarget = targetSelect.value;

            if (!selectedTarget || !TARGET_PRESETS[selectedTarget]) {
                targetStatsDiv.innerHTML = '<div class="flex items-center justify-center h-24"><i class="fas fa-crosshairs mr-2"></i>請先選擇目標</div>';
                return;
            }

            const stats = TARGET_PRESETS[selectedTarget];
            targetStatsDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-2 text-white">
                    <div>防禦: <span class="font-medium">${stats.defense}</span></div>
                    <div>元素抗性: <span class="font-medium">${stats.elemental_resist}</span></div>
                    <div>格擋: <span class="font-medium">${stats.block}</span></div>
                    <div>會心抗性: <span class="font-medium">${stats.crit_resist}</span></div>
                    <div>抵禦: <span class="font-medium">${stats.defense_base}</span></div>
                    <div>氣盾: <span class="font-medium">${stats.shield_base}</span></div>
                </div>
            `;
        }

        // 更新職業效果顯示
        function updateProfessionEffects() {
            const effectsDiv = document.getElementById('professionEffects');
            
            if (!selectedMainProfession && !selectedTrait) {
                effectsDiv.innerHTML = '<div class="flex items-center justify-center h-full text-white"><i class="fas fa-info-circle mr-2"></i>請選擇職業查看效果</div>';
                return;
            }
            
            let effectsHtml = '<div class="space-y-2 text-white">';
            
            if (selectedMainProfession) {
                const professionType = PROFESSION_TYPES["內功"].includes(selectedMainProfession) ? "內功" : "外功";
                effectsHtml += `
                    <div class="text-sm">
                        <span class="font-medium">主職業:</span> ${selectedMainProfession} (${professionType})
                        <div class="text-xs ml-2">${PROFESSION_EFFECTS[selectedMainProfession]}</div>
                    </div>
                `;
            }
            
            if (selectedTrait) {
                const traitType = PROFESSION_TYPES["內功"].includes(selectedTrait) ? "內功" : "外功";
                
                // 特殊規則顯示
                let traitEffect = PROFESSION_EFFECTS[selectedTrait];
                if (specialRuleActive) {
                    traitEffect = "每點力量額外+0.83命中";
                }
                
                effectsHtml += `
                    <div class="text-sm">
                        <span class="font-medium">特質:</span> ${selectedTrait} (${traitType})
                        <div class="text-xs ml-2">${traitEffect}</div>
                    </div>
                `;
            }
            
            // 顯示有效五維屬性
            if (selectedMainProfession) {
                const professionType = PROFESSION_TYPES["內功"].includes(selectedMainProfession) ? "內功" : "外功";
                const validStats = professionType === "內功" ? "氣海、身法、根骨、耐力" : "力量、身法、根骨、耐力";
                effectsHtml += `
                    <div class="text-xs mt-2 pt-2 border-t">
                        有效五維屬性: ${validStats}
                    </div>
                `;
            }
            
            effectsHtml += '</div>';
            effectsDiv.innerHTML = effectsHtml;
        }

        // 修復的套裝效果計算函數（支持向下兼容）
        function calculateSetEffects(equipmentConfig) {
            const setEffects = {
                upperSet: { level: null, count: 0, effects: [] },
                lowerSet: { level: null, count: 0, effects: [] },
                uniqueEffects: [] // 新增：存儲所有獨珍效果
            };
            
            // 上半身百鍊裝備等級列表
            const upperItems = [];
            UPPER_BODY_SLOTS.forEach(slot => {
                const itemName = equipmentConfig[slot];
                if (itemName && (itemName.includes('81百鍊') || itemName.includes('83百鍊') || itemName.includes('85百鍊'))) {
                    if (itemName.includes('81百鍊')) upperItems.push(81);
                    else if (itemName.includes('83百鍊')) upperItems.push(83);
                    else if (itemName.includes('85百鍊')) upperItems.push(85);
                }
                
                // 檢查是否為獨珍裝備
                if (itemName && UNIQUE_EFFECTS[itemName]) {
                    setEffects.uniqueEffects.push({
                        name: itemName,
                        effect: UNIQUE_EFFECTS[itemName]
                    });
                }
            });
            
            // 修復的邏輯：分別計算兩件套和四件套效果（向下兼容）
            if (upperItems.length > 0) {
                // 兩件套效果：取可激活的最高等級
                const sortedUpper = [...upperItems].sort((a, b) => b - a); // 降序排序
                let twoSetLevel = null;
                for (const level of [85, 83, 81]) {
                    if (sortedUpper.filter(itemLevel => itemLevel >= level).length >= 2) {
                        twoSetLevel = level;
                        break;
                    }
                }
                
                // 四件套效果：取可激活的最高等級
                let fourSetLevel = null;
                for (const level of [85, 83, 81]) {
                    if (sortedUpper.filter(itemLevel => itemLevel >= level).length >= 4) {
                        fourSetLevel = level;
                        break;
                    }
                }
                
                // 應用效果
                if (twoSetLevel) {
                    setEffects.upperSet.effects.push({
                        name: "2件套效果",
                        value: `首領克制 +${SET_EFFECTS[twoSetLevel].upperTwoSet.bossDamage}`,
                        level: twoSetLevel
                    });
                }
                
                if (fourSetLevel) {
                    setEffects.upperSet.effects.push({
                        name: "4件套效果",
                        value: `首領克制 +${(SET_EFFECTS[fourSetLevel].upperFourSet.bossDamagePercent * 100).toFixed(1)}%`,
                        level: fourSetLevel
                    });
                }
            }
            
            // 統計下半身套裝（支持向下兼容）
            const lowerItems = [];
            LOWER_BODY_SLOTS.forEach(slot => {
                const itemName = equipmentConfig[slot];
                if (itemName && (itemName.includes('81百鍊') || itemName.includes('83百鍊') || itemName.includes('85百鍊'))) {
                    if (itemName.includes('81百鍊')) lowerItems.push(81);
                    else if (itemName.includes('83百鍊')) lowerItems.push(83);
                    else if (itemName.includes('85百鍊')) lowerItems.push(85);
                }
                
                // 檢查是否為獨珍裝備
                if (itemName && UNIQUE_EFFECTS[itemName]) {
                    setEffects.uniqueEffects.push({
                        name: itemName,
                        effect: UNIQUE_EFFECTS[itemName]
                    });
                }
            });
            
            // 下半身只有兩件套效果
            if (lowerItems.length > 0) {
                // 兩件套效果：取可激活的最高等級
                const sortedLower = [...lowerItems].sort((a, b) => b - a); // 降序排序
                let twoSetLevel = null;
                for (const level of [85, 83, 81]) {
                    if (sortedLower.filter(itemLevel => itemLevel >= level).length >= 2) {
                        twoSetLevel = level;
                        break;
                    }
                }
                
                // 應用效果
                if (twoSetLevel) {
                    setEffects.lowerSet.effects.push({
                        name: "2件套效果",
                        value: `首領克制 +${(SET_EFFECTS[twoSetLevel].lowerTwoSet.bossDamagePercent * 100).toFixed(1)}%, 會心傷害 +${(SET_EFFECTS[twoSetLevel].lowerTwoSet.critDamage * 100).toFixed(1)}%`,
                        level: twoSetLevel
                    });
                }
            }
            
            return setEffects;
        }
        
        // 應用套裝效果到屬性
        /**
        * 套用「獨珍／套裝」效果到 stats 陣列。
        * 支援：
        *   • 靜態效果 → 用物件描述 (例如 { attack:200, bossDamage:150 })
        *   • 函式效果 → (statsArr, totalsObj) => { ... } 內自行對 statsArr 加值
        *
        * @param {number[]} stats       長度 15 的屬性陣列，直接就地修改
        * @param {Object}   setEffects  由 getSelectedSetEffects() 回傳，
        *                               需至少含 uniqueEffects: string[]  
        * @param {Object}   totals      buildTotalStatsObject() 產生的總屬性物件
        */
        function applySetEffects(stats, setEffects, totals) {
			if (!setEffects || !Array.isArray(setEffects.uniqueEffects)) return;

			setEffects.uniqueEffects.forEach(unique => {
				const effectDef = unique.effect;
				if (!effectDef) return;
        
				// 函數型效果 - 傳入總屬性物件
				if (typeof effectDef === 'function') {
					// 確保傳入的 totals 物件包含所有五維屬性
					const totalsWithDefaults = {
						strength: totals?.strength || 0,
						qihai: totals?.qihai || 0,
						agility: totals?.agility || 0,
						constitution: totals?.constitution || 0,
						endurance: totals?.endurance || 0
					};
					const effectResult = effectDef(totalsWithDefaults);
            
					// 應用函數返回的效果
					if (effectResult) {
						for (const stat in effectResult) {
							const value = effectResult[stat];
							switch(stat) {
								case 'attack': stats[0] += value; break;
								case 'elementalAttack': stats[1] += value; break;
								case 'armorBreak': stats[2] += value; break;
								case 'ignoreResist': stats[3] += value; break;
								case 'hit': stats[4] += value; break;
								case 'crit': stats[5] += value; break;
								case 'bossDamage': stats[6] += value; break;
								case 'bossDamagePercent': stats[7] += value; break;
								case 'critDamage': stats[8] += value; break;
								case 'shieldBreak': stats[9] += value; break;
							}
						}
					}
				} 
				// 物件型效果
				else if (typeof effectDef === 'object') {
					if (effectDef.attack) stats[0] += effectDef.attack;
					if (effectDef.elementalAttack) stats[1] += effectDef.elementalAttack;
					if (effectDef.armorBreak) stats[2] += effectDef.armorBreak;
					if (effectDef.ignoreResist) stats[3] += effectDef.ignoreResist;
					if (effectDef.hit) stats[4] += effectDef.hit;
					if (effectDef.crit) stats[5] += effectDef.crit;
					if (effectDef.bossDamage) stats[6] += effectDef.bossDamage;
					if (effectDef.bossDamagePercent) stats[7] += effectDef.bossDamagePercent;
					if (effectDef.critDamage) stats[8] += effectDef.critDamage;
					if (effectDef.shieldBreak) stats[9] += effectDef.shieldBreak;
				}
			});
		}
        
        // 更新套裝效果顯示 - 修復了錯誤顯示問題
        function updateSetEffects(type) {
            const containerId = type === 'current' ? 'currentSetEffects' : 'newSetEffects';
            const equipmentConfig = type === 'current' ? currentWearingEquipment : newEquipment;
            
            const setEffects = calculateSetEffects(equipmentConfig);
            let html = '';
            
            // 上半身套裝效果
            if (setEffects.upperSet.effects.length > 0) {
                setEffects.upperSet.effects.forEach(effect => {
                    const levelClass = `level-${effect.level}`;
                    html += `
                        <div class="mb-3 p-3 bg-white bg-opacity-20 rounded-lg border border-blue-100">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-white">${effect.name}</span>
                                <span class="level-badge ${levelClass}">${effect.level}級</span>
                            </div>
                            <div class="mt-1 text-sm text-white">${effect.value}</div>
                        </div>
                    `;
                });
            } else {
                html += `<div class="text-sm mb-2 text-white"><i class="fas fa-times-circle text-red-500 mr-1"></i>無百鍊套裝效果</div>`;
            }
            
            // 下半身套裝效果
            if (setEffects.lowerSet.effects.length > 0) {
                setEffects.lowerSet.effects.forEach(effect => {
                    const levelClass = `level-${effect.level}`;
                    html += `
                        <div class="mb-3 p-3 bg-white bg-opacity-20 rounded-lg border border-purple-100">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-white">${effect.name}</span>
                                <span class="level-badge ${levelClass}">${effect.level}級</span>
                            </div>
                            <div class="mt-1 text-sm text-white">${effect.value}</div>
                        </div>
                    `;
                });
            } else {
                html += `<div class="text-sm text-white"><i class="fas fa-times-circle text-red-500 mr-1"></i>無百鍊飾品套裝效果</div>`;
            }
            
            // 獨珍效果顯示
            if (setEffects.uniqueEffects.length > 0) {
                html += `<div class="mt-4 pt-4 border-t border-gray-200"><h4 class="font-medium mb-2 text-white">獨珍效果</h4>`;
                setEffects.uniqueEffects.forEach(unique => {
                    let effectText = '';
                    const effect = unique.effect;
                    
                    if (effect.attack) effectText += `攻擊 +${effect.attack}, `;
                    if (effect.elementalAttack) effectText += `元素攻擊 +${effect.elementalAttack}, `;
                    if (effect.armorBreak) effectText += `破防 +${effect.armorBreak}, `;
                    if (effect.ignoreResist) effectText += `忽視抗性 +${effect.ignoreResist}, `;
                    if (effect.hit) effectText += `命中 +${effect.hit}, `;
                    if (effect.crit) effectText += `會心 +${effect.crit}, `;
                    if (effect.bossDamage) effectText += `首領克制 +${effect.bossDamage}, `;
                    if (effect.bossDamagePercent) effectText += `首領克制 +${(effect.bossDamagePercent * 100).toFixed(1)}%, `;
                    if (effect.critDamage) effectText += `會心傷害 +${(effect.critDamage * 100).toFixed(1)}%, `;
                    if (effect.shieldBreak) effectText += `破盾 +${effect.shieldBreak}, `;
                    
                    // 去掉最後的逗號和空格
                    if (effectText.length > 0) {
                        effectText = effectText.slice(0, -2);
                    }
                    
                    html += `
                        <div class="mb-3 p-3 bg-white bg-opacity-20 rounded-lg border border-yellow-200">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-white">${unique.name}</span>
                                <span class="unique-badge">獨珍</span>
                            </div>
                            <div class="mt-1 text-sm text-white">${effectText}</div>
                        </div>
                    `;
                });
                html += `</div>`;
            } else {
                html += `<div class="mt-4 pt-4 border-t border-gray-200 text-sm text-white"><i class="fas fa-times-circle text-red-500 mr-1"></i>無獨珍效果</div>`;
            }
            
            document.getElementById(containerId).innerHTML = html;
        }

        // 應用五維屬性轉換
        function applyFiveStatsConversion(stats) {
            // 檢查是否選擇了主職業
            if (!selectedMainProfession) {
                return; // 如果沒有選擇職業，不進行轉換
            }
            
            const professionType = PROFESSION_TYPES["內功"].includes(selectedMainProfession) ? "內功" : "外功";
            
            const strength = stats[10]; // 力量
            const qihai = stats[11]; // 氣海
            const agility = stats[12]; // 身法
            const constitution = stats[13]; // 根骨
            const endurance = stats[14]; // 耐力

            // 基礎五維轉換（根據職業類型）
            if (professionType === "外功") {
                // 外功職業：力量、身法、根骨、耐力
                if (strength > 0) {
                    stats[0] += strength * FIVE_STATS_CONVERSION["力量"]["攻擊"]; // 攻擊
                    stats[2] += strength * FIVE_STATS_CONVERSION["力量"]["破防"]; // 破防
                }
            } else {
                // 內功職業：氣海、身法、根骨、耐力
                if (qihai > 0) {
                    stats[0] += qihai * FIVE_STATS_CONVERSION["氣海"]["攻擊"]; // 攻擊
                    stats[2] += qihai * FIVE_STATS_CONVERSION["氣海"]["破防"]; // 破防
                }
            }

            // 身法轉換（所有職業都有）
            if (agility > 0) {
                stats[5] += agility * FIVE_STATS_CONVERSION["身法"]["會心"]; // 會心
                stats[4] += agility * FIVE_STATS_CONVERSION["身法"]["命中"]; // 命中
            }

            // 應用主職業特殊轉換
            applyProfessionConversion(stats, selectedMainProfession);
            
            // 應用特質轉換
            if (selectedTrait) {
                applyProfessionConversion(stats, selectedTrait, true);
            }
        }

        // 應用職業特殊轉換
        function applyProfessionConversion(stats, profession, isTrait = false) {
            if (!profession) {
                return;
            }
            
            let conversions = PROFESSION_CONVERSION[profession];
            
            // 特殊規則處理：主職業為外功且特質為神相時
            if (isTrait && selectedMainProfession && PROFESSION_TYPES["外功"].includes(selectedMainProfession) && 
                profession === "神相") {
                conversions = {"力量": {"命中": 0.83}};
            }
            
            if (!conversions) {
                return;
            }
            
            Object.keys(conversions).forEach(statName => {
                let statIndex;
                switch(statName) {
                    case "力量": statIndex = 10; break;
                    case "氣海": statIndex = 11; break;
                    case "身法": statIndex = 12; break;
                    case "根骨": statIndex = 13; break;
                    case "耐力": statIndex = 14; break;
                    default: return;
                }
                
                const statValue = stats[statIndex];
                if (statValue > 0) {
                    const targetStats = conversions[statName];
                    Object.keys(targetStats).forEach(targetStat => {
                        let targetIndex;
                        switch(targetStat) {
                            case "攻擊": targetIndex = 0; break;
                            case "破防": targetIndex = 2; break;
                            case "命中": targetIndex = 4; break;
                            case "會心": targetIndex = 5; break;
                            default: return;
                        }
                        
                        stats[targetIndex] += statValue * targetStats[targetStat];
                    });
                }
            });
        }

        // 計算基礎面板
        function calculateBaseStats() {
            // 獲取當前總屬性（包含五維轉換後的結果）
            const currentTotalStats = {
                attack: parseFloat(document.getElementById('current_attack').value) || 0,
                elementalAttack: parseFloat(document.getElementById('current_elemental_attack').value) || 0,
                armorBreak: parseFloat(document.getElementById('current_armor_break').value) || 0,
                ignoreResist: parseFloat(document.getElementById('current_ignore_resist').value) || 0,
                hit: parseFloat(document.getElementById('current_hit').value) || 0,
                crit: parseFloat(document.getElementById('current_crit').value) || 0,
                bossDamage: parseFloat(document.getElementById('current_boss_damage').value) || 0,
                bossDamagePercent: parseFloat(document.getElementById('current_boss_damage_percent').value) || 0,
                critDamage: parseFloat(document.getElementById('current_crit_damage').value) || 0,
                shieldBreak: parseFloat(document.getElementById('current_shield_break').value) || 0,
                strength: parseFloat(document.getElementById('current_strength').value) || 0,
                qihai: parseFloat(document.getElementById('current_qihai').value) || 0,
                agility: parseFloat(document.getElementById('current_agility').value) || 0,
                constitution: parseFloat(document.getElementById('current_constitution').value) || 0,
                endurance: parseFloat(document.getElementById('current_endurance').value) || 0
            };
            
            // 計算當前穿戴裝備的屬性
            const currentEquipmentStats = new Array(15).fill(0);
            
            EQUIPMENT_SLOTS.forEach(slot => {
                const selectedItem = currentWearingEquipment[slot];
                if (selectedItem && EQUIPMENT_PRESETS_BY_SLOT[slot][selectedItem]) {
                    const itemStats = EQUIPMENT_PRESETS_BY_SLOT[slot][selectedItem];
                    for (let i = 0; i < itemStats.length; i++) {
                        currentEquipmentStats[i] += itemStats[i];
                    }
                }
            });
            
            // 計算套裝效果
            const currentSetEffects = calculateSetEffects(currentWearingEquipment);
			
			const totalFiveStats = {
				strength: currentTotalStats.strength,
				qihai:    currentTotalStats.qihai,
				agility:  currentTotalStats.agility,
				constitution: currentTotalStats.constitution,  // 120 → 攻擊加成正確
				endurance:    currentTotalStats.endurance
			};
                     
            // 應用套裝效果到裝備屬性
            applySetEffects(currentEquipmentStats, currentSetEffects, totalFiveStats);
            
            // 應用五維屬性轉換
            applyFiveStatsConversion(currentEquipmentStats);
            
            // 計算基礎面板 = 當前總屬性 - 當前裝備屬性
            baseStats[0] = currentTotalStats.attack - currentEquipmentStats[0]; // 攻擊
            baseStats[1] = currentTotalStats.elementalAttack - currentEquipmentStats[1]; // 元素攻擊
            baseStats[2] = currentTotalStats.armorBreak - currentEquipmentStats[2]; // 破防
            baseStats[3] = currentTotalStats.ignoreResist - currentEquipmentStats[3]; // 忽視抗性
            baseStats[4] = currentTotalStats.hit - currentEquipmentStats[4]; // 命中
            baseStats[5] = currentTotalStats.crit - currentEquipmentStats[5]; // 會心
            baseStats[6] = currentTotalStats.bossDamage - currentEquipmentStats[6]; // 首領克制
            baseStats[7] = (currentTotalStats.bossDamagePercent / 100) - currentEquipmentStats[7]; // 首領克制% (轉換為小數)
            baseStats[8] = (currentTotalStats.critDamage / 100) - currentEquipmentStats[8]; // 會心傷害% (轉換為小數)
            baseStats[9] = currentTotalStats.shieldBreak - currentEquipmentStats[9]; // 破盾
            baseStats[10] = currentTotalStats.strength - currentEquipmentStats[10]; // 力量
            baseStats[11] = currentTotalStats.qihai - currentEquipmentStats[11]; // 氣海
            baseStats[12] = currentTotalStats.agility - currentEquipmentStats[12]; // 身法
            baseStats[13] = currentTotalStats.constitution - currentEquipmentStats[13]; // 根骨
            baseStats[14] = currentTotalStats.endurance - currentEquipmentStats[14]; // 耐力
            
            // 顯示基礎面板
            displayBaseStats();
        }
        
        // 顯示基礎面板
        function displayBaseStats() {
            const baseStatsDiv = document.getElementById('baseStatsDisplay');
            
            const statLabels = [
                '攻擊', '元素攻擊', '破防', '忽視抗性', '命中', '會心', '首領克制', 
                '首領克制%', '會心傷害', '破盾', '力量', '氣海', '身法', '根骨', '耐力'
            ];
            
            let html = '<div class="grid grid-cols-2 gap-1">';
            for (let i = 0; i < 15; i++) {
                const value = i === 7 || i === 8 ? 
                    `${(baseStats[i] * 100).toFixed(2)}%` : 
                    Math.round(baseStats[i]);
                html += `<div class="text-xs">${statLabels[i]}: <span class="font-medium">${value}</span></div>`;
            }
            html += '</div>';
            
            baseStatsDiv.innerHTML = html;
            
            // 添加動畫效果
            baseStatsDiv.classList.add('fade-in');
            setTimeout(() => {
                baseStatsDiv.classList.remove('fade-in');
            }, 500);
        }
        
        // 計算新裝備屬性
        function calculateNewEquipmentStats() {
            // 計算新裝備的屬性
            const newEquipmentStats = new Array(15).fill(0);
            
            EQUIPMENT_SLOTS.forEach(slot => {
                const selectedItem = newEquipment[slot];
                if (selectedItem && EQUIPMENT_PRESETS_BY_SLOT[slot][selectedItem]) {
                    const itemStats = EQUIPMENT_PRESETS_BY_SLOT[slot][selectedItem];
                    for (let i = 0; i < itemStats.length; i++) {
                        newEquipmentStats[i] += itemStats[i];
                    }
                }
            });
            
            // 計算套裝效果
            const newSetEffects = calculateSetEffects(newEquipment);
			
			// 計算五維總值（基礎面板 + 新裝備）
			const totalFiveStats = {
				strength: baseStats[10] + newEquipmentStats[10],
				qihai: baseStats[11] + newEquipmentStats[11],
				agility: baseStats[12] + newEquipmentStats[12],
				constitution: baseStats[13] + newEquipmentStats[13],
				endurance: baseStats[14] + newEquipmentStats[14]
			};
            
            // 應用套裝效果到裝備屬性
            applySetEffects(newEquipmentStats, newSetEffects, totalFiveStats);
			
            
            // 應用五維屬性轉換
            applyFiveStatsConversion(newEquipmentStats);
            
            // 顯示新裝備屬性
            displayNewEquipmentStats(newEquipmentStats);
        }
        
        // 顯示新裝備屬性
        function displayNewEquipmentStats(stats) {
            const newEquipmentStatsDiv = document.getElementById('newEquipmentStatsDisplay');
            
            // 計算當前裝備屬性用於對比
            const currentEquipmentStats = new Array(15).fill(0);
            
            EQUIPMENT_SLOTS.forEach(slot => {
                const selectedItem = currentWearingEquipment[slot];
                if (selectedItem && EQUIPMENT_PRESETS_BY_SLOT[slot][selectedItem]) {
                    const itemStats = EQUIPMENT_PRESETS_BY_SLOT[slot][selectedItem];
                    for (let i = 0; i < itemStats.length; i++) {
                        currentEquipmentStats[i] += itemStats[i];
                    }
                }
            });
            
            // 計算當前裝備套裝效果
            const currentSetEffects = calculateSetEffects(currentWearingEquipment);
			
			// 計算五維總值（基礎面板 + 裝備）
			const totalFiveStats = {
				strength: baseStats[10] + currentEquipmentStats[10],
				qihai: baseStats[11] + currentEquipmentStats[11],
				agility: baseStats[12] + currentEquipmentStats[12],
				constitution: baseStats[13] + currentEquipmentStats[13],
				endurance: baseStats[14] + currentEquipmentStats[14]
			};
            
            // 應用套裝效果到裝備屬性
            applySetEffects(currentEquipmentStats, currentSetEffects, totalFiveStats);
            
            // 應用五維屬性轉換
            applyFiveStatsConversion(currentEquipmentStats);
            
            const statLabels = [
                '攻擊', '元素攻擊', '破防', '忽視抗性', '命中', '會心', '首領克制', 
                '首領克制%', '會心傷害', '破盾', '力量', '氣海', '身法', '根骨', '耐力'
            ];
            
            let html = '<div class="space-y-1 max-h-80 overflow-y-auto pr-2">';
            for (let i = 0; i < 15; i++) {
                const newValue = i === 7 || i === 8 ? stats[i] * 100 : stats[i];
                const currentValue = i === 7 || i === 8 ? currentEquipmentStats[i] * 100 : currentEquipmentStats[i];
                const diff = newValue - currentValue;
                
                const diffColor = diff > 0 ? 'text-green-300' : diff < 0 ? 'text-red-300' : 'text-gray-300';
                const diffSign = diff > 0 ? '+' : '';
                const diffText = i === 7 || i === 8 ? 
                    `${diffSign}${diff.toFixed(2)}%` : 
                    `${diffSign}${Math.round(diff)}`;
                
                const newValueText = i === 7 || i === 8 ? 
                    `${newValue.toFixed(2)}%` : 
                    Math.round(newValue);
                
                const icon = diff > 0 ? 'fa-arrow-up text-green-300' : 
                            diff < 0 ? 'fa-arrow-down text-red-300' : 'fa-equals text-gray-300';
                
                html += `
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-white">${statLabels[i]}:</span>
                        <div class="flex items-center space-x-2">
                            <span class="font-medium text-white">${newValueText}</span>
                            <span class="${diffColor}"><i class="fas ${icon} mr-1"></i>(${diffText})</span>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            
            newEquipmentStatsDiv.innerHTML = html;
            
            // 添加動畫效果
            newEquipmentStatsDiv.classList.add('fade-in');
            setTimeout(() => {
                newEquipmentStatsDiv.classList.remove('fade-in');
            }, 500);
        }

        // 傷害計算功能
        function calculateDamage() {
            const targetSelect = document.getElementById('targetSelect');
            const selectedTarget = targetSelect.value;
            
            if (!selectedTarget || !TARGET_PRESETS[selectedTarget]) {
                alert('請先選擇目標！');
                return;
            }
            
            // 檢查是否已計算基礎面板
            if (baseStats.every(stat => stat === 0)) {
                alert('請先計算基礎面板！');
                return;
            }
            
            const targetStats = TARGET_PRESETS[selectedTarget];
            
            try {
                // 計算當前總屬性 (基礎面板 + 當前裝備)
                const currentEquipmentStats = new Array(15).fill(0);
                
                EQUIPMENT_SLOTS.forEach(slot => {
                    const selectedItem = currentWearingEquipment[slot];
                    if (selectedItem && EQUIPMENT_PRESETS_BY_SLOT[slot][selectedItem]) {
                        const itemStats = EQUIPMENT_PRESETS_BY_SLOT[slot][selectedItem];
                        for (let i = 0; i < itemStats.length; i++) {
                            currentEquipmentStats[i] += itemStats[i];
                        }
                    }
                });
                
                // 計算當前裝備套裝效果
                const currentSetEffects = calculateSetEffects(currentWearingEquipment);
				
				const totalFiveStatsCurrent = {
					strength: baseStats[10] + currentEquipmentStats[10],
					qihai:    baseStats[11] + currentEquipmentStats[11],
					agility:  baseStats[12] + currentEquipmentStats[12],
					constitution: baseStats[13] + currentEquipmentStats[13],
					endurance:    baseStats[14] + currentEquipmentStats[14]
				};
                
                // 應用套裝效果到裝備屬性
                applySetEffects(currentEquipmentStats, currentSetEffects);
                
                // 應用五維屬性轉換
                applyFiveStatsConversion(currentEquipmentStats);
                
                const currentTotalStats = {
                    attack: baseStats[0] + currentEquipmentStats[0],
                    elementalAttack: baseStats[1] + currentEquipmentStats[1],
                    armorBreak: baseStats[2] + currentEquipmentStats[2],
                    ignoreResist: baseStats[3] + currentEquipmentStats[3],
                    hit: baseStats[4] + currentEquipmentStats[4],
                    crit: baseStats[5] + currentEquipmentStats[5],
                    bossDamage: baseStats[6] + currentEquipmentStats[6],
                    bossDamagePercent: baseStats[7] + currentEquipmentStats[7],
                    critDamage: baseStats[8] + currentEquipmentStats[8],
                    shieldBreak: baseStats[9] + currentEquipmentStats[9]
                };
                
                // 計算新裝備總屬性 (基礎面板 + 新裝備 + 手動調整)
                const newEquipmentStats = new Array(15).fill(0);
                
                EQUIPMENT_SLOTS.forEach(slot => {
                    const selectedItem = newEquipment[slot];
                    if (selectedItem && EQUIPMENT_PRESETS_BY_SLOT[slot][selectedItem]) {
                        const itemStats = EQUIPMENT_PRESETS_BY_SLOT[slot][selectedItem];
                        for (let i = 0; i < itemStats.length; i++) {
                            newEquipmentStats[i] += itemStats[i];
                        }
                    }
                });
                
                // 計算新裝備套裝效果
                const newSetEffects = calculateSetEffects(newEquipment);
                
                // 應用套裝效果到裝備屬性
                applySetEffects(newEquipmentStats, newSetEffects);
                
                // 應用五維屬性轉換
                applyFiveStatsConversion(newEquipmentStats);
                
                // 獲取手動調整值
                const manualAdjustments = {
                    attack: parseFloat(document.getElementById('manual_attack').value) || 0,
                    elementalAttack: parseFloat(document.getElementById('manual_elemental_attack').value) || 0,
                    armorBreak: parseFloat(document.getElementById('manual_armor_break').value) || 0,
                    ignoreResist: parseFloat(document.getElementById('manual_ignore_resist').value) || 0,
                    hit: parseFloat(document.getElementById('manual_hit').value) || 0,
                    crit: parseFloat(document.getElementById('manual_crit').value) || 0,
                    bossDamage: parseFloat(document.getElementById('manual_boss_damage').value) || 0,
                    bossDamagePercent: parseFloat(document.getElementById('manual_boss_damage_percent').value) || 0,
                    critDamage: parseFloat(document.getElementById('manual_crit_damage').value) || 0,
                    shieldBreak: 0,
                    strength: parseFloat(document.getElementById('manual_strength').value) || 0,
                    qihai: parseFloat(document.getElementById('manual_qihai').value) || 0,
                    agility: parseFloat(document.getElementById('manual_agility').value) || 0,
                    constitution: parseFloat(document.getElementById('manual_constitution').value) || 0,
                    endurance: parseFloat(document.getElementById('manual_endurance').value) || 0
                };
                
                // 將手動微調的五維屬性轉換為戰鬥屬性
                const manualFiveStatsArray = new Array(15).fill(0);
                manualFiveStatsArray[10] = manualAdjustments.strength;
                manualFiveStatsArray[11] = manualAdjustments.qihai;
                manualFiveStatsArray[12] = manualAdjustments.agility;
                manualFiveStatsArray[13] = manualAdjustments.constitution;
                manualFiveStatsArray[14] = manualAdjustments.endurance;

                // 應用五維轉換
                applyFiveStatsConversion(manualFiveStatsArray);
                
                // 計算新配置總屬性（包含手動調整）
                const newTotalStats = {
                    attack: baseStats[0] + newEquipmentStats[0] + manualAdjustments.attack + manualFiveStatsArray[0],
                    elementalAttack: baseStats[1] + newEquipmentStats[1] + manualAdjustments.elementalAttack + manualFiveStatsArray[1],
                    armorBreak: baseStats[2] + newEquipmentStats[2] + manualAdjustments.armorBreak + manualFiveStatsArray[2],
                    ignoreResist: baseStats[3] + newEquipmentStats[3] + manualAdjustments.ignoreResist + manualFiveStatsArray[3],
                    hit: baseStats[4] + newEquipmentStats[4] + manualAdjustments.hit + manualFiveStatsArray[4],
                    crit: baseStats[5] + newEquipmentStats[5] + manualAdjustments.crit + manualFiveStatsArray[5],
                    bossDamage: baseStats[6] + newEquipmentStats[6] + manualAdjustments.bossDamage + manualFiveStatsArray[6],
                    bossDamagePercent: baseStats[7] + newEquipmentStats[7] + (manualAdjustments.bossDamagePercent / 100) + manualFiveStatsArray[7],
                    critDamage: baseStats[8] + newEquipmentStats[8] + (manualAdjustments.critDamage / 100) + manualFiveStatsArray[8],
                    shieldBreak: baseStats[9] + newEquipmentStats[9] + manualAdjustments.shieldBreak + manualFiveStatsArray[9]
                };
                
                // 計算傷害
                const currentDamage = calculateSingleDamage(currentTotalStats, targetStats);
                const newDamage = calculateSingleDamage(newTotalStats, targetStats);
                
                // 計算差異
                const damageDiff = newDamage - currentDamage;
                const damageIncrease = currentDamage > 0 ? (damageDiff / currentDamage * 100) : 0;
                
                // 顯示結果
                displayDamageResults(currentDamage, newDamage, damageDiff, damageIncrease);
            } catch (error) {
                console.error('計算傷害時發生錯誤:', error);
                alert('計算傷害時發生錯誤，請檢查輸入值');
            }
        }
        
        function calculateSingleDamage(stats, targetStats) {
            // 固定值
            const BASE_SKILL = 0;
            const SKILL_ENHANCE = 0;
            const ATTACK_SPEED = 0;
            const BOSS_RESIST = 0; // 首領抵禦
            
            // 防禦穿透率計算
            const defenseAfterBreak = Math.max(0, targetStats.defense - stats.armorBreak);
            const defensePenetration = 1 - (defenseAfterBreak / (defenseAfterBreak + 2860));
            
            // 元素穿透率計算
            const elementalResistAfterIgnore = Math.max(0, targetStats.elemental_resist - stats.ignoreResist);
            const elementalPenetration = 1 - (elementalResistAfterIgnore / (elementalResistAfterIgnore + 520));
            
            // 真實命中計算
            const realHit = (1.4315 * stats.hit) / (stats.hit + 714);
            
            // 真實格擋計算
            const realBlock = (1.44 * targetStats.block) / (targetStats.block + 722);
            
            // 命中率計算
            const hitRate = Math.min(1, Math.max(0, 0.95 + (realHit - realBlock)));
            
            // 會心率計算
            const critDiff = Math.max(0, stats.crit - targetStats.crit_resist + 90);
            const critRate = Math.min(1, Math.max(0, (1.15 * critDiff) / (critDiff + 941)));
            
            // 傷害計算
            const physicalDamage = (stats.attack + stats.bossDamage - BOSS_RESIST - targetStats.shield_base + BASE_SKILL) * defensePenetration;
            const elementalDamage = stats.elementalAttack * elementalPenetration;
            
            const baseDamage = physicalDamage + elementalDamage;
            
            const hitMultiplier = hitRate * (critRate * stats.critDamage + (1 - critRate)) + (1 - hitRate) * 0.5;
            const bossMultiplier = 1 + stats.bossDamagePercent;
            const skillMultiplier = 1 + SKILL_ENHANCE;
            const speedMultiplier = 1 + ATTACK_SPEED / 2;
            
            const finalDamage = baseDamage * hitMultiplier * bossMultiplier * skillMultiplier * speedMultiplier;
            
            return Math.max(0, finalDamage);
        }
        
        function displayDamageResults(currentDamage, newDamage, damageDiff, damageIncrease) {
            const resultsDiv = document.getElementById('damageResults');
            
            const diffColor = damageDiff >= 0 ? 'text-green-300' : 'text-red-500';
            const diffBg = damageDiff >= 0 ? 'bg-green-900 bg-opacity-20 border-green-300' : 'bg-red-900 bg-opacity-20 border-red-700';
            const diffSign = damageDiff >= 0 ? '+' : '';
            
            const increaseColor = damageIncrease >= 0 ? 'text-green-300' : 'text-red-500';
            const increaseBg = damageIncrease >= 0 ? 'bg-green-900 bg-opacity-20 border-green-300' : 'bg-red-900 bg-opacity-20 border-red-700';
            const increaseSign = damageIncrease >= 0 ? '+' : '';
            
            const damageClass = damageDiff >= 0 ? 'damage-increase' : 'damage-decrease';
            
            resultsDiv.innerHTML = `
                <div class="space-y-3 fade-in">
                    <div class="${damageClass} damage-result-card ${diffBg}">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-xs mb-1 text-white">傷害差異</div>
                                <div class="text-xl font-bold ${diffColor}">${diffSign}${Math.round(damageDiff).toLocaleString()}</div>
                            </div>
                            <div class="text-3xl ${diffColor}">
                                ${damageDiff >= 0 ? '📈' : '📉'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-blue-900 bg-opacity-20 p-3 rounded-lg border border-blue-300">
                            <div class="text-xs mb-1 text-white">當前配置傷害</div>
                            <div class="text-lg font-bold text-white">${Math.round(currentDamage).toLocaleString()}</div>
                        </div>
                        
                        <div class="bg-purple-900 bg-opacity-20 p-3 rounded-lg border border-purple-300">
                            <div class="text-xs mb-1 text-white">新配置傷害</div>
                            <div class="text-lg font-bold text-white">${Math.round(newDamage).toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <div class="${increaseBg} p-3 rounded-lg border">
                        <div class="text-xs mb-1 text-white">增傷百分比</div>
                        <div class="text-lg font-bold ${increaseColor}">${increaseSign}${damageIncrease.toFixed(2)}%</div>
                    </div>
                </div>
            `;
            
            // 添加動畫效果
            setTimeout(() => {
                resultsDiv.querySelector('.fade-in').classList.remove('fade-in');
            }, 500);
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', loadExternalData);
		
		//星星動畫效果
		function createStars() {
			const starsContainer = document.getElementById('stars');
			const starCount = 400; // 星星數量

			for (let i = 0; i < starCount; i++) {
				const star = document.createElement('div');
				star.className = 'star';
				const size = Math.random() * 3 + 0.5;
				const opacity = Math.random() * 0.8 + 0.2;
				star.style.cssText = `
					left: ${Math.random() * 100}%;
					top: ${Math.random() * 100}%;
					width: ${size}px;
					height: ${size}px;
					opacity: ${opacity};
					animation-delay: ${Math.random() * 4}s;
					animation-duration: ${Math.random() * 4 + 2}s;
				`;
				starsContainer.appendChild(star);
			}
		}
		createStars();
    </script>

</body>
</html>